#!/usr/bin/env ruby

if (%w( -h --help -help help ) & ARGV).length > 0
  puts "usage: djsd [-hv]"
  puts "starts dotjs server in the foreground. kill with ^C"
  exit
end

if ARGV.include?('-v')
  puts "djsd 1.5"
  exit
end

require 'webrick'

dotjs = Class.new(WEBrick::HTTPServlet::AbstractServlet) do
  def do_GET(request, response)
    files = all_files_for(request.path.gsub('/', ''))
    body = build_body(files)
    response.status = body.empty? ? 204 : 200

    if origin = detect_origin(request)
      response['Access-Control-Allow-Origin'] = origin
    end

    response['Content-Type'] = 'text/javascript'
    response.body = body
  end

  def all_files_for(path)
    files = []

    while(path =~ /\..+\.js/) #loop while we have anything ore than com.js
      files.unshift(path)
      path = path.sub(/.*?\./, '') #removing the first sub domain
    end

    files.unshift("default.js")
  end

  def build_body(files)
    files.map do |file|
      file = File.expand_path(file)
      File.read(file) if File.file?(file)
    end.compact.join("\n")
  end

  def detect_origin(req)
    path   = req.path
    origin = req.header['origin']
    search = path.gsub('/','').gsub(/\.js$/,'') + '$'

    if origin.length == 1 && path.length != 1 && origin[0].match(search)
      origin[0]
    end
  end
end

port = ARGV.join(" ").match(/-p (\d+)/)[1] || 3131
server = WEBrick::HTTPServer.new(:Port => port)
server.mount('/', dotjs)

%w( INT TERM ).each do |sig|
  trap(sig) { server.shutdown }
end

server.start
